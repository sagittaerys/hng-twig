{% extends 'base.twig' %}

{% block title %}Manage Tickets | TicketApp{% endblock %}

{% block content %}
<div class="tickets-wrapper">
  <div class="tickets-container">
    <div class="tickets-header">
      <h1 class="tickets-title">Manage Tickets</h1>
      <div class="duex-btns">
        <a href="/dashboard" class="back-btn">‚Üê Back to Dashboard</a>
        <a href="/tickets?modal=create" class="create-btn">+ Create Ticket</a>
      </div>
    </div>

    {# Empty state #}
    {% if tickets is empty %}
      <div class="empty-state">
        <div class="empty-state-icon">üé´</div>
        <h2 class="empty-state-title">No tickets yet</h2>
        <p class="empty-state-text">Create your first ticket to get started</p>
        <a href="/tickets?modal=create" class="create-btn">Create Ticket</a>
      </div>
    {% else %}
      <div class="tickets-grid">
        {% for ticket in tickets %}
          <div class="ticket-card">
            <div class="ticket-header">
              <h3 class="ticket-title">{{ ticket.title }}</h3>
              <span
                class="status-badge"
                style="background-color: {{ ticket.status == 'open' ? '#10b981' : (ticket.status == 'in_progress' ? '#f59e0b' : '#6b7280') }};">
                {{ ticket.status == 'open' ? 'Open' : (ticket.status == 'in_progress' ? 'In Progress' : 'Closed') }}
              </span>
            </div>

            {% if ticket.description %}
              <p class="ticket-description">{{ ticket.description }}</p>
            {% endif %}

            <div class="ticket-meta">
              <span class="priority-badge">Priority: {{ ticket.priority }}</span>
              <div class="ticket-actions">
                <a href="/tickets?modal=edit&id={{ ticket.id }}" class="action-btn edit-btn">Edit</a>
                <form method="POST" action="/tickets/delete" style="display:inline">
                  <input type="hidden" name="id" value="{{ ticket.id }}">
                  <button type="submit" class="action-btn delete-btn">Delete</button>
                </form>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

{# --- Create / Edit Modal --- #}
{% set old = session.form_old ?? {} %}
{% set formErrors = session.form_errors ?? {} %}
{# clear these so they don't persist next render (controller would unset flash; do it here too) #}
{% do session.remove('form_errors') if session.form_errors is defined %}
{% do session.remove('form_old') if session.form_old is defined %}

<div id="modalOverlay" class="modal-overlay" style="display: {{ showModal ? 'flex' : 'none' }};">
  <div class="modal" onclick="event.stopPropagation()">
    <h2 class="modal-header">
      {{ editingTicket ? 'Edit Ticket' : 'Create New Ticket' }}
    </h2>

    <form method="POST" action="{{ editingTicket ? '/tickets/update' : '/tickets' }}">
      {% if editingTicket %}
        <input type="hidden" name="id" value="{{ editingTicket.id }}">
      {% endif %}

      <div class="form-group">
        <label class="form-label">Title <span class="required">*</span></label>
        <input
          name="title"
          type="text"
          class="form-input {{ formErrors.title ? 'error' : '' }}"
          value="{{ (old.title ?? (editingTicket.title ?? ''))|e }}"
          placeholder="Enter ticket title"
        />
        {% if formErrors.title %}
          <p class="error-message">{{ formErrors.title }}</p>
        {% endif %}
      </div>

      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea
          name="description"
          class="form-textarea {{ formErrors.description ? 'error' : '' }}"
          placeholder="Enter ticket description"
        >{{ (old.description ?? (editingTicket.description ?? ''))|e }}</textarea>
        {% if formErrors.description %}
          <p class="error-message">{{ formErrors.description }}</p>
        {% endif %}
      </div>

      <div class="form-group">
        <label class="form-label">Status <span class="required">*</span></label>
        <select name="status" class="form-select {{ formErrors.status ? 'error' : '' }}">
          {% set selectedStatus = old.status ?? editingTicket.status ?? 'open' %}
          <option value="open" {{ selectedStatus == 'open' ? 'selected' : '' }}>Open</option>
          <option value="in_progress" {{ selectedStatus == 'in_progress' ? 'selected' : '' }}>In Progress</option>
          <option value="closed" {{ selectedStatus == 'closed' ? 'selected' : '' }}>Closed</option>
        </select>
        {% if formErrors.status %}
          <p class="error-message">{{ formErrors.status }}</p>
        {% endif %}
      </div>

      <div class="form-group">
        <label class="form-label">Priority</label>
        <select name="priority" class="form-select">
          {% set selPriority = old.priority ?? editingTicket.priority ?? 'medium' %}
          <option value="low" {{ selPriority == 'low' ? 'selected' : '' }}>Low</option>
          <option value="medium" {{ selPriority == 'medium' ? 'selected' : '' }}>Medium</option>
          <option value="high" {{ selPriority == 'high' ? 'selected' : '' }}>High</option>
        </select>
      </div>

      <div class="modal-actions">
        <a href="/tickets" class="modal-btn modal-btn-secondary">Cancel</a>
        <button type="submit" class="modal-btn modal-btn-primary">
          {{ editingTicket ? 'Update' : 'Create' }}
        </button>
      </div>
    </form>
  </div>
</div>

{# --- Delete Confirmation Modal (fallback if you want explicit modal) --- #}
{% if showDeleteConfirm and ticketToDelete %}
  <div id="deleteConfirm" class="modal-overlay" style="display:flex;">
    <div class="confirm-modal" onclick="event.stopPropagation()">
      <h3 class="confirm-title">Delete Ticket</h3>
      <p class="confirm-text">Are you sure you want to delete "{{ ticketToDelete.title }}"? This action cannot be undone.</p>
      <div class="confirm-actions">
        <a href="/tickets" class="confirm-btn confirm-btn-cancel">Cancel</a>
        <form method="POST" action="/tickets/delete" style="display:flex; gap:1rem; width:100%;">
          <input type="hidden" name="id" value="{{ ticketToDelete.id }}">
          <button type="submit" class="confirm-btn confirm-btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
{% endif %}

{# --- Toast --- #}
{% if flash %}
  <div class="toast {{ flash.type }}">{{ flash.message }}</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
  // Close modal when clicking outside
  const overlay = document.getElementById('modalOverlay');
  if (overlay) {
    overlay.addEventListener('click', () => {
      window.location.href = '/tickets';
    });
  }

  // Close delete confirm overlay by clicking outside
  const deleteOverlay = document.getElementById('deleteConfirm');
  if (deleteOverlay) {
    deleteOverlay.addEventListener('click', () => {
      window.location.href = '/tickets';
    });
  }

  // Auto-hide toast after 3s
  document.addEventListener('DOMContentLoaded', function () {
    const toast = document.querySelector('.toast');
    if (toast) {
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }
  });
</script>
{% endblock %}
